---
title: "R Notebook"
output: html_notebook
---

```{r}
data <- read.csv("Extended_data_clean.csv", header = T)
```

```{r}
###
###Permutation t tests
###

perm_t_test=function(x,y,iter=1e3){
  
  T0=abs(mean(x)-mean(y))  # define the test statistic
  T_stat=numeric(iter) # a vector to store the values of each iteration
  x_pooled=c(x,y) # pooled sample
  n=length(x_pooled)
  n1=length(x)
  
  for(perm in 1:iter){ # loop for conditional MC
    # permutation:
    permutation <- sample(1:n)
    x_perm <- x_pooled[permutation]
    x1_perm <- x_perm[1:n1]
    x2_perm <- x_perm[(n1+1):n]
    # test statistic:
    T_stat[perm] <- abs(mean(x1_perm) - mean(x2_perm))
    
  }
  
  # p-value
  p_val <- sum(T_stat>=T0)/iter
  return(p_val)
}
```

```{r}
###
# Rank test to see if CLASE_TIPO (private vs public) scores are different --> DA MODIFICARE IN PERMUTATION TEST
###

# x.1 public
# x.2 private

x.1 <- data$P_Puntaje_[which(data$CLASE_TIPO %in% c(1,2,3))]
x.2 <- data$P_Puntaje_[which(data$CLASE_TIPO %in% c(4,5,6))]

alpha <- 0.05
wilcox.test(x.1,y=x.2, paired=F, conf.level = 1-alpha)$p.value

```

```{r}
alpha <- 0.05
wilcox.test(x.1,y=x.2, paired=F, conf.level = 1-alpha, alternative = "less")$p.value
```
We can confirm that scores of public and private schools are different


```{r}
boxplot(x.1, x.2)
```
We can confirm that the private school perform better than the public ones.



```{r}
###
# Test to see if scores are different for each CALENDARIO
###


x1 <- data$P_Puntaje_[which(data$CALENDARIO == 1)]
x2 <- data$P_Puntaje_[which(data$CALENDARIO == 3)]

perm_t_test(x1, x2)
```

```{r}
hist(x1)
hist(x2)
```

Schools from Calendario B have different distribution than those from Calendario A.


```{r}
alpha <- 0.05
wilcox.test(x1, y = x2, paired=F, conf.level = 1-alpha,
            alternative = "less")$p.value
```

```{r}
median(x1)
median(x2)
```

With this test we confirm that the median score of students from Calendario B schools is higher than Calendario A.



```{r}
###
# Test to see if there are difference in the scores according to the zone (COD_LOCA)
###

table(data$COD_LOCA)
```

```{r}
###
### ANOVA
###

scores <- data$P_Puntaje_
LOC <- as.factor(data$COD_LOCA)

fit <- aov(scores ~ LOC)
summary(fit)

T0 <- summary(fit)[[1]][1,4]  # extract the test statistic
T0
```


```{R}
B = 1e3

T_stat <- numeric(B) 
n <- dim(data)[1]

for(perm in 1:B){
  # Permutation:
  permutation <- sample(1:n)
  scores_perm <- scores[permutation]
  fit_perm <- aov(scores_perm ~ LOC)
  
  # Test statistic:
  T_stat[perm] <- summary(fit_perm)[[1]][1,4]
}
```

```{r}
hist(T_stat,xlim=range(c(T_stat,T0)),breaks=30)
abline(v=T0,col=3,lwd=2)
```

```{r}
p_val <- sum(T_stat>=T0)/B
p_val
```

```{r}
g = length(unique(data$COD_LOCA))
plot(scores ~ LOC, xlab='treat', col=rainbow(length(levels(LOC))), main='Original Data')
```

There is statistical evidence to assure that there is a difference in the scores of schools from different zones.


```{r}
# see whether the number of students is relevant. 
quantile(data$EVALUADOS,probs=c(0.25,0.5,0.75))
#25,49,75
#tenere la mediana mi sembrava un brutto treshold, quindi ho messo
#100 per dividere tra scuole piccole e grandi, se avete
#un treshold migliore modificate il codice --

med <- median(data$EVALUADOS)
small_schools = data[which(data$EVALUADOS<=92),]
big_schools = data[which(data$EVALUADOS>92),]

set.seed(123)

perm_t_test=function(x,y,iter=1e3){
  
  T0=abs(median(x)-median(y))  # define the test statistic
  T_stat=numeric(iter) # a vector to store the values of each iteration
  x_pooled=c(x,y) # pooled sample
  n=length(x_pooled)
  n1=length(x)
  
  for(perm in 1:iter){ # loop for conditional MC
    # permutation:
    permutation <- sample(1:n)
    x_perm <- x_pooled[permutation]
    x1_perm <- x_perm[1:n1]
    x2_perm <- x_perm[(n1+1):n]
    # test statistic:
    T_stat[perm] <- abs(median(x1_perm) - median(x2_perm))
    
  }
  
  # p-value
  p_val <- sum(T_stat>=T0)/iter
  return(p_val)
}

B2 = 1e4

perm_t_test(small_schools$P_Puntaje_,big_schools$P_Puntaje_)
#p-value is 0

hist(small_schools$P_Puntaje_,col = "green")
hist(big_schools$P_Puntaje_,col="blue")

#small schools perform better
```




